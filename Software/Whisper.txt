Content-Type: text/x-zim-wiki
Wiki-Format: zim 0.6
Creation-Date: 2024-11-30T21:46:21+02:00

====== Whisper ======

[ @sound @openai @whisper ]

«Whisper» — нейронная сеть для распознавания речи, automatic speech recognition (ASR) от OpenAI. Может преобразовывать аудиофайлы в текст. Работает локально. Опубликована с открытым исходным кодом, поддерживает множество языков (русский и украинский) под «MIT License».

===== Установка =====

* [[Debian:Install:Whisper]]

===== Условности =====

У Whisper есть несколько моделей:

* //tiny//, //base//: быстро, меньшая точность.
* //small//, //medium//: хороший баланс между точностью и скоростью.
* //large//: высокая точность, но требует больше ресурсов.
* //turbo//: быстро, largo, maestoso, воют кулеры.

Нейросеть потребляет все ресурсы, до которых найдёт доступ. На большом количестве файлов с применением «большой» модели гудеть кулерами начнёт даже ноутбук, в котором в принципе нет вентиляторов. Разумно начинать с модели „small” и переходить на более продвинутую только при явной необходимости. Также из сострадания к ресурсам компьютера разумно придирчиво отбирать, какие аудиофайлы действительно надо транскрибировать.

Модель „small” на момент тестирования весит 461 МБ. Модель „large” [[https://github.com/openai/whisper/blob/main/README.md#available-models-and-languages|потребует]] скачать почти три гигабайта. 

Каждая модель Whisper перед первым её применением будет автоматически загружена из сети и сохранена в кэше профиля пользователя: ''~/.cache/whisper/'' в файле с расширением ''.pt''

Условная скорость работы:

* wav на один голос, моно, 1 min = 5 Mb, с внятной речью, через модель ''small'' транскрибируется за условные 1 мин 15 сек.
* wav на один голос, моно, 5 min = 25 Mb, с внятной речью, через модель ''small'' транскрибируется за 07 мин 10 сек.
* wav на один голос, моно, 10 min = 50 Mb… и так далее.

===== Использование Whisper =====

==== Предварительная конвертация аудио ====

Whisper работает лучше с аудио в формате WAV с частотой 16 кГц. Если файлы записаны в другом формате, можно конвертировать их через ffmpeg:

''ffmpeg -i your_audio_file.mp3 -ar 16000 -ac 1 output.wav''

Если надо конвертировать ВСЕ mp3-файлы в каталоге:

''for file in /INPUT_FOLDER/*.mp3; do ffmpeg -i "$file" -ar 16000 -ac 1 "${file%.mp3}.wav"; done''

Может быть удобнее обработать файлы из одного каталога и сохранить сконвертированные файлы в другом каталоге:

''for file in /INPUT_FOLDER/*.mp3; do ffmpeg -i "$file" -ar 16000 -ac 1 "/OUTPUT_FOLDER/$(basename "${file%.mp3}.wav")"; done''

==== Включить Whisper ====

Перейти в каталог с уже созданным (при установке Whisper) виртуальным окружением Python:

''cd ~/whisper/''

Активировать его:

''source whisper_env/bin/activate''

Для выхода из виртуального окружения надо выполнить в том же каталоге команду “''deactivate''”.

=== Преобразовать в текст один аудиофайл ===

''whisper АУДИОФАЙЛ.mp3 --language Russian --model medium''

В каталоге, из которого выполняется эта команда, появится несколько файлов с расшифрованным текстом:
*.json
*.srt
*.tsv
*.txt
*.vtt

В *.json записывается какой-то RTF-подобный текст:

''{"text": " \u0441 \u0447\u0435\u0433\u043e \u043e\u0431\u044b\u0447\u043d\u043e \u043d\u0430\u0447\u0438\u043d\u0430\u0435\u0442\u0441\u044f…''

В *.txt текст записан очень неудобно для восприятия — сплошным потоком, иногда вообще без знаков препинания.

В *.vtt записан текст в виде формата субтитров WEBVTT (Web Video Text Tracks) — он используется в веб-приложениях и поддерживается HTML5. В файлах *.srt то же самое, только ещё и с нумерацией реплик. В принципе файл *.vtt — самый удобный для восприятия.

Чтобы не создавать множество текстовых файлов, можно указать Whisper нужный формат файла с текстом:

''whisper АУДИОФАЙЛ.mp3 --language Russian --model medium --output_format vtt''

Если обрабатываемый «АУДИОФАЙЛ.mp3» находится в другом каталоге, то разумно сохранить расшифровку рядом с ним:

'''
FILE="/home/astenix/Аудио/1min.wav"; whisper $FILE --language Russian --model medium --output_dir "$(dirname $FILE)" --output_format vtt
'''

Кавычки нужны на случай если в полном пути к файлу будут пробелы.

=== Преобразовать в текст множество аудиофайлов ===

Преобразовать все аудиофайлы в цикле в отдельном каталоге через модель “turbo”. В переменной FOLDER не надо указывать закрывающий слэш:

'''
FOLDER="/home/astenix/Аудио"; for FILE in $FOLDER/*.wav; do whisper "$FILE" --language Russian --model medium --output_dir "$(dirname "$FILE")" --output_format vtt; done
'''
